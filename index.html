<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mango Mart</title>
  <link rel="stylesheet" href="main.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    window.RAZORPAY_KEY = 'rzp_test_RFU56fR6NeZ9T2';
    window.GMAPS_KEY = 'AIzaSyCb1le2CESuZX7vWSz5UeNQA4N-Ub9KysI';
    // Supabase project credentials (configured)
    window.SUPABASE_URL = 'https://hlkwnncqnlduczkmjnth.supabase.co';
    window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhsa3dubmNxbmxkdWN6a21qbnRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNTI2NzYsImV4cCI6MjA3NTkyODY3Nn0.dC9fMKnSR9DmM0eFGt3dXffVc8IVsxAz2xAl9n69yZs';
  </script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="supabaseClient.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCb1le2CESuZX7vWSz5UeNQA4N-Ub9KysI"></script>
  <script defer src="storage.js"></script>
  <script defer src="dataservice.js"></script>
  <script defer src="auth.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <div id="loading" class="loading-container"><div class="loading-spinner"></div></div>

  <!-- LOGIN / REGISTER -->
  <div id="login-page" class="page">
    <div class="login-container">
      <div class="login-card">
        <div class="card-header"><h2>Mango Mart</h2><p id="auth-title">Sign in to continue</p></div>
        <form id="login-form" class="card-content">
          <div class="form-group"><label>Email</label><input id="email" type="email" required></div>
          <div class="form-group"><label>Password</label><input id="password" type="password" required></div>
          <div id="login-error" class="error-message" style="display:none"></div>
          <button type="submit" class="btn btn-primary"><span id="login-text">Login</span></button>
          <div style="margin-top:.5rem;font-size:.9rem">Don't have an account? <a id="show-register" href="#">Register</a></div>
        </form>
        <form id="register-form" class="card-content" style="display:none">
          <div class="form-group"><label>Name</label><input id="reg_name" type="text" required></div>
          <div class="form-group"><label>Email</label><input id="reg_email" type="email" required></div>
          <div class="form-group"><label>Password</label><input id="reg_password" type="password" required></div>
          <div id="register-error" class="error-message" style="display:none"></div>
          <button type="submit" class="btn btn-primary">Create Account</button>
          <div style="margin-top:.5rem;font-size:.9rem">Already have an account? <a id="show-login" href="#">Login</a></div>
        </form>
      </div>
      <!-- Demo credentials removed -->
    </div>
  </div>

  <!-- CUSTOMER DASHBOARD -->
  <div id="customer-dashboard" class="page" style="display:none">
    <header class="dashboard-header">
      <div id="logo-home" class="logo" style="cursor:pointer"><i class="fas fa-shopping-bag"></i> Mango Mart</div>
      <div class="searchbar autosuggest">
        <input id="global-search-input" placeholder="Search products..." autocomplete="off">
        <div id="autosuggest-list" class="autosuggest-list" style="display:none"></div>
      </div>
      <div class="header-right">
        <div id="cart-icon" class="cart-icon"><i class="fas fa-shopping-cart"></i><span id="cart-count" class="cart-count">0</span></div>
        <div class="hamburger-menu">
          <button id="hamburger-btn" class="hamburger-btn">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <div id="hamburger-dropdown" class="hamburger-dropdown">
            <button id="logout-btn" class="btn btn-outline">Logout</button>
          </div>
        </div>
      </div>
    </header>
    <main class="dashboard-main">
      <div class="tabs">
        <button class="tab-button active" data-tab="products">Products</button>
        <button class="tab-button" data-tab="orders">Orders</button>
      </div>

      <div id="products-tab" class="tab-content active">
        <div class="heading-banner">
          <div class="heading-content">
            <h1>Get your favourite products delivered to your doorstep</h1>
            <p class="sub">Fresh picks, fair prices, and fast delivery — all in one place.</p>
          </div>
          <img class="heading-illustration" alt="Hero" loading="lazy" src="hero.png" />
        </div>
        <div class="category-cards">
          <div class="category-card" data-category="Fruits & Vegetables">
            <div class="category-media cat1"></div>
            <div class="category-info">
              <h3>Fruits & Vegetables</h3>
              <p>Farm-fresh fruits and leafy greens.</p>
              <button class="btn btn-primary" data-action="shop-now" data-category="Fruits & Vegetables">Shop Now</button>
            </div>
          </div>
          <div class="category-card" data-category="Groceries">
            <div class="category-media cat2"></div>
            <div class="category-info">
              <h3>Groceries</h3>
              <p>Foods, snacks, and beverages.</p>
              <button class="btn btn-primary" data-action="shop-now" data-category="Groceries">Shop Now</button>
            </div>
          </div>
          <div class="category-card" data-category="Stationery & Cleaning">
            <div class="category-media cat3"></div>
            <div class="category-info">
              <h3>Stationery & Cleaning</h3>
              <p>Supplies for home and office.</p>
              <button class="btn btn-primary" data-action="shop-now" data-category="Stationery & Cleaning">Shop Now</button>
            </div>
          </div>
        </div>
        <div id="card-view-header" class="card-view-header" style="display:none">
          <div style="display:flex;align-items:center;gap:.5rem">
            <button id="back-to-cards" class="btn btn-outline">Back</button>
            <div class="card-view-title"></div>
          </div>
        </div>
        
        <div id="products-grid" class="products-grid" style="display:none"></div>
        <div id="product-detail" class="panel" style="display:none"></div>
      </div>
      <div id="cart-tab" class="tab-content">
        <div class="section-header">
          <div style="display:flex;align-items:center;gap:.5rem">
            <button id="back-from-cart" class="back-button">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <h2 style="margin:0">Your Cart</h2>
          </div>
        </div>
        <div id="cart-items"></div>
        <div id="cart-total" class="cart-total"></div>
        <button id="checkout-btn" class="btn btn-primary">Checkout</button>
      </div>
      <div id="orders-tab" class="tab-content">
        <div class="panel">
          <div class="section-header">
            <div style="display:flex;align-items:center;gap:.5rem">
              <button id="back-from-orders" class="back-button">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <h2 style="margin:0">Current Orders</h2>
            </div>
          </div>
          <div id="orders-current" class="orders-grid"></div>
        </div>
        <div class="panel" style="margin-top:1rem">
          <div class="section-header"><h2>Previous Orders</h2></div>
          <div class="section-header" style="gap:.5rem;align-items:center">
            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
              <select id="prev-filter-range">
                <option value="all" selected>All time</option>
                <option value="7d">Last 7 days</option>
                <option value="30d">Last 30 days</option>
                <option value="year">This year</option>
              </select>
              <select id="prev-filter-rating">
                <option value="any" selected>Any rating</option>
                <option value="rated">Rated</option>
                <option value="unrated">Unrated</option>
              </select>
            </div>
          </div>
          <div id="orders-previous" class="orders-list"></div>
        </div>
        <div id="customer-tracking" class="panel" style="display:none;margin-top:1rem">
          <div class="section-header"><h3>Live Order Tracking</h3><button id="close-tracking" class="btn btn-outline">Close</button></div>
          <div id="customer-map" class="map-container" style="height:260px;border-radius:12px;overflow:hidden"></div>
          <div class="tracking-metrics">
            <div class="metric"><i class="fas fa-motorcycle"></i><span id="metric-eta">ETA —</span></div>
            <div class="metric"><i class="fas fa-route"></i><span id="metric-distance">Distance —</span></div>
          </div>
          <div id="customer-notifications" class="notifications-list" style="margin-top:1rem"></div>
        </div>
      </div>
    </main>
    <footer class="site-footer">
      <div class="footer-inner">
        <div class="footer-left">
          <a href="#" aria-label="Instagram" class="social-link"><i class="fab fa-instagram"></i></a>
          <a href="#" aria-label="Facebook" class="social-link"><i class="fab fa-facebook"></i></a>
          <a href="#" aria-label="WhatsApp" class="social-link"><i class="fab fa-whatsapp"></i></a>
        </div>
        <div class="footer-center">
          <div class="footer-brand"><i class="fas fa-shopping-bag"></i> Mango Mart</div>
          <div class="footer-copy">© <span id="footer-year"></span> Mango Mart. All rights reserved.</div>
        </div>
        <div class="footer-right">
          <a href="#" class="footer-link">Privacy Policy</a>
          <a href="#" class="footer-link">Shipping Policy</a>
          <a href="#" class="footer-link">Refund Policy</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="admin-dashboard" class="page" style="display:none">
    <header class="dashboard-header"><div class="logo"><i class="fas fa-cog"></i> Admin Panel</div><button id="admin-logout-btn" class="btn btn-outline">Logout</button></header>
    <main class="dashboard-main">
      <div class="tabs">
        <button class="tab-button active" data-tab="overview">Overview</button>
        <button class="tab-button" data-tab="admin-products">Products</button>
        <button class="tab-button" data-tab="delivery-agents">Delivery Agents</button>
      </div>

      <div id="overview-tab" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card"><i class="fas fa-box"></i><div><h3 id="total-products">0</h3><p>Products</p></div></div>
          <div class="stat-card"><i class="fas fa-shopping-cart"></i><div><h3 id="total-orders">0</h3><p>Orders</p></div></div>
          <div class="stat-card"><i class="fas fa-truck"></i><div><h3 id="total-agents">0</h3><p>Agents</p></div></div>
        </div>
        <div class="admin-panels">
          <div class="panel">
            <div class="section-header">
              <h3>Recent Orders</h3>
              <button class="delete-all-orders-btn" onclick="app.deleteAllOrders()" title="Delete all orders">
                <i class="fas fa-trash-alt"></i> Delete All Orders
              </button>
            </div>
            <div id="admin-recent-orders" class="cart-items"></div>
          </div>
          <div class="panel">
            <h3>Top-Selling Products</h3>
            <div id="admin-top-products" class="cart-items"></div>
          </div>
          <div class="panel">
            <h3>Customer Search Insights</h3>
            <div id="admin-search-logs" class="cart-items"></div>
          </div>
          <div class="panel">
            <div class="section-header"><h3>Sales</h3>
              <div>
                <select id="chart-sales-range">
                  <option value="weekly" selected>Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
            </div>
            <canvas id="chart-sales" height="160"></canvas>
          </div>
          <div class="panel">
            <h3>Revenue (Last 7 Days)</h3>
            <canvas id="chart-revenue" height="160"></canvas>
          </div>
          
        </div>
      </div>

      <div id="admin-products-tab" class="tab-content">
        <div class="section-header"><h2>Products</h2><button id="add-product-btn" class="btn btn-primary">Add Product</button></div>
        <div id="admin-products-grid"></div>
      </div>

      <div id="delivery-agents-tab" class="tab-content">
        <div class="section-header"><h2>Delivery Agents</h2><button id="add-agent-btn" class="btn btn-primary">Add Agent</button></div>
        <div id="admin-agents-list"></div>
      </div>
    </main>
  </div>

  <!-- DELIVERY DASHBOARD -->
  <div id="delivery-dashboard" class="page" style="display:none">
    <header class="delivery-header">
      <div class="delivery-header-content">
        <div class="delivery-logo">
          <i class="fas fa-motorcycle"></i>
          <div class="delivery-logo-text">
            <h1>Delivery Hub</h1>
            <p>Track & Manage Orders</p>
          </div>
        </div>
        <div class="delivery-stats">
          <div class="stat-item">
            <i class="fas fa-clock"></i>
            <span id="delivery-active-count">0</span>
            <label>Active</label>
          </div>
          <div class="stat-item">
            <i class="fas fa-check-circle"></i>
            <span id="delivery-completed-count">0</span>
            <label>Completed</label>
          </div>
        </div>
        <button id="delivery-logout-btn" class="btn btn-outline delivery-logout">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </div>
    </header>
    
    <main class="delivery-main">
      <!-- Live Map Section -->
      <div class="delivery-map-section">
        <div class="section-header">
          <h2><i class="fas fa-map-marked-alt"></i> Live Tracking</h2>
          <div class="map-controls">
            <button class="map-btn" id="center-map-btn" title="Center Map">
              <i class="fas fa-crosshairs"></i>
            </button>
            <button class="map-btn" id="refresh-location-btn" title="Refresh Location">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>
        <div id="delivery-map" class="delivery-map-container"></div>
        <div class="delivery-status-bar">
          <div class="status-indicator">
            <div class="status-dot online"></div>
            <span>Online & Ready</span>
          </div>
          <div class="location-info">
            <i class="fas fa-map-marker-alt"></i>
            <span id="current-location">Getting location...</span>
          </div>
        </div>
      </div>

      <!-- Orders Section -->
      <div class="delivery-orders-section">
        <div class="orders-header">
          <h2><i class="fas fa-clipboard-list"></i> All Orders from Table Editor</h2>
          <div class="orders-filter">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="pending">Pending</button>
            <button class="filter-btn" data-filter="picked_up">Picked Up</button>
            <button class="filter-btn" data-filter="out_for_delivery">Out for Delivery</button>
          </div>
        </div>
        <div id="assigned-orders" class="orders-grid"></div>
      </div>

      <!-- Previous Orders Section -->
      <div class="delivery-history-section">
<div class="section-header">
          <h2><i class="fas fa-history"></i> Delivery History</h2>
          <div class="history-controls">
            <div class="history-stats">
              <span id="delivery-today-count">0</span> deliveries today
            </div>
            <div class="history-action-buttons">
              <button class="clear-history-btn" onclick="app.clearDeliveryHistory()" title="Clear all delivery history">
                <i class="fas fa-trash-alt"></i> Clear All
              </button>
              <button class="load-orders-btn" onclick="app.loadAllOrdersFromSupabase()" title="Load all orders from Supabase table editor">
                <i class="fas fa-download"></i> Load All Orders
              </button>
            </div>
          </div>
        </div>
        <div id="delivered-orders" class="history-grid"></div>
      </div>
    </main>
  </div>

  <!-- MODAL -->
  <div id="modal-overlay" class="modal-overlay" style="display:none"><div id="modal-content" class="modal-content"></div></div>
  
  <!-- CART NOTIFICATION -->
  <div id="cart-notification" class="cart-notification">
    <div class="cart-notification-content">
      <i class="fas fa-check-circle"></i>
      <span>Added to cart!</span>
    </div>
  </div>
</body>
</html>
